\documentclass{article}
\usepackage{hyperref}
\title{Setup Blog with GitHub Actions}
\author{Michal Hoftich}
\def\makeht{\texttt{make4ht}}
\begin{document}
\maketitle

This article describes how to configure GitHub Actions to automatically compile \LaTeX\ sources
for a static blog built with tools like \makeht{} and Jekyll. It covers file tracking,
automatic build triggering, and committing generated files back to the repository.

You can find the YAML configuration in the
\href{https://github.com/michal-h21/testblog/blob/main/.github/workflows/main.yml}{.github/workflows/main.yml}
file.

\tableofcontents

\section{Problem: Git and Modification Times}

Git does not preserve file modification times when cloning or checking out repositories.  
However, tools like \makeht{} or other build systems may rely on these timestamps to detect changed files.  
To compile only updated \LaTeX\ sources, we need to \textit{restore original modification times}
from the commit history.

\subsection{Restoring Timestamps with GitHub Actions}

We can restore modification times using a custom script that extracts timestamps from git history:

\begin{verbatim}
- name: Restore timestamps
  run: |
    git ls-files -z | while read -d '' file; do
      if [ -f "$file" ]; then
        timestamp=$(git log --pretty=format:%cd -n 1 --date=iso -- "$file")
        if [ -n "$timestamp" ]; then
          touch -d "$timestamp" "$file"
        fi
      fi
    done
\end{verbatim}

This requires the full commit history, not just the latest commit.
You must ensure the following step is included in your GitHub Actions workflow:

\begin{verbatim}
- uses: actions/checkout@v4
  with:
    fetch-depth: 0
\end{verbatim}

This fetches the complete Git history so the script can determine modification times correctly.

\section{Working with Multiple Branches}

For better organization, we use two branches:
\begin{itemize}
  \item \texttt{main} branch: Contains source \LaTeX\ files and build scripts
  \item \texttt{html} branch: Contains generated HTML files served by GitHub Pages
\end{itemize}

The workflow checks out both branches and synchronizes changes from \texttt{main} to \texttt{html} before compilation.

\section{Compiling \LaTeX\ on GitHub}

It is possible to run the full \LaTeX{} to HTML compilation process directly on GitHub, 
without needing to generate files locally.

\subsection{Using a Marker File to Trigger Compilation}

To control whether a file should be rebuilt, we use a marker file named after the source file 
with the extension \texttt{.published}. It stores the timestamp of the last successful publication.

It is created automatically if you use the \texttt{staticsite} extension, but you can also create it manually,
if you want to compile your file only on Github, without local testing.

For example, for a file named \texttt{tex\_filename.tex}, create a corresponding marker file:

\begin{verbatim}
$ date +%s > tex_filename.published
\end{verbatim}

This command stores the current UNIX timestamp in the marker file. The build script 
on the GitHub server can then compare this value with the file's modification time 
to decide whether recompilation is needed.

Whether the \texttt{.published} file was created manually or by the \texttt{staticsite}
extension, make sure to commit it to the repositoryâ€”GitHub Actions needs it to
be present during the build.

\subsection{Compilation with TexLive Action}

The compilation process uses the \href{https://github.com/xu-cheng/texlive-action}{\texttt{xu-cheng/texlive-action}}
which provides a full TeX Live environment. The workflow changes to the \texttt{texposts} directory
and executes the \texttt{rebuild.sh} script. This script handles the compilation of modified
\LaTeX\ documents into HTML format by processing only the files that have changed since
the last build, ensuring efficient compilation of large documentation projects.

\section{Committing Generated Files Back to GitHub}

Every build generates HTML and CSS files, and these are automatically committed
to the \texttt{html} branch for publishing with GitHub Pages, using the
\href{https://github.com/stefanzweifel/git-auto-commit-action}{\texttt{git-auto-commit-action}}.

A typical workflow step might look like this:

\begin{verbatim}
- name: Autocommit generated files
  uses: stefanzweifel/git-auto-commit-action@v4
  with:
    commit_message: "Save generated files"
    file_pattern: docs/*
    branch: html
    push_options: --force
\end{verbatim}

This commits and pushes the generated files to the \texttt{html} branch automatically, 
making them available to GitHub Pages.

\section{Configure Github Pages}

To configure GitHub Pages to serve content from the \texttt{docs} directory in the \texttt{html} branch, follow these steps:

\begin{enumerate}
  \item Open your repository on GitHub.
  \item Navigate to the \textbf{Settings} tab.
  \item In the left-hand menu, select \textbf{Pages}.
  \item Under the \textbf{Source} section:
    \begin{itemize}
      \item Set the branch to \texttt{html}.
      \item Set the folder to \texttt{/docs}.
    \end{itemize}
  \item Click \textbf{Save}.
\end{enumerate}

\subsection*{Accessing your blog}

Once GitHub Pages is configured, your blog will be available at:

\begin{quote}
\texttt{https://\textit{username}.github.io/\textit{repository-name}/}
\end{quote}

For example, if your GitHub username is \texttt{janedoe} and your repository is named \texttt{tex-blog}, the blog will be published at:

\begin{quote}
\texttt{https://janedoe.github.io/tex-blog/}
\end{quote}

\section{Preventing Infinite Build Loops}

To prevent infinite build loops when generated files are committed back to the repository,
configure the workflow to ignore changes in the \texttt{docs/} directory:

\begin{verbatim}
on: 
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
\end{verbatim}

This ensures that commits containing only generated files won't trigger new workflow runs.

\end{document}
